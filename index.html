<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D GO – Sua loja de impressão 3D</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #fff;
      color: #111;
    }
    header {
      background-color: #e60000;
      padding: 1.5rem;
      text-align: center;
      color: white;
      font-size: 1.5rem;
    }
    main {
      max-width: 800px;
      margin: auto;
      padding: 2rem;
    }
    label {
      font-weight: bold;
      margin-top: 1rem;
      display: block;
    }
    input, textarea, button {
      width: 100%;
      padding: 0.75rem;
      margin-top: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    button {
      background-color: #e60000;
      color: white;
      cursor: pointer;
      border: none;
      margin-top: 1.5rem;
    }
    canvas {
      width: 100%;
      height: 400px;
      display: block;
      margin: 1rem 0;
      border: 1px solid #ccc;
    }
    .resultado {
      margin-top: 1rem;
      font-weight: bold;
    }
    #qrcode {
      text-align: center;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <header>
    3D GO – Sua loja de impressão 3D
  </header>
  <main>
    <label for="stlFile">Envie seu arquivo STL</label>
    <input type="file" id="stlFile" accept=".stl">
    <canvas id="previewCanvas"></canvas>

    <p class="resultado" id="volumeDisplay"></p>
    <p class="resultado" id="priceDisplay"></p>

    <label for="nome">Nome completo</label>
    <input type="text" id="nome" required>

    <label for="email">Seu e-mail</label>
    <input type="email" id="email" required>

    <label for="endereco">Endereço para envio</label>
    <textarea id="endereco" rows="3" required></textarea>

    <button id="enviarPedido">Enviar Pedido</button>
    <div id="qrcode"></div>
  </main>

  <!-- Dependências -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/STLLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("45ZVb6pBbMGwIVhyo");

    let volumeGlobal = 0;
    let precoGlobal = 0;
    let nomeArquivo = "";

    const canvas = document.getElementById("previewCanvas");
    const renderer = new THREE.WebGLRenderer({ canvas });
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(1, 1, 1);
    scene.add(light);
    camera.position.z = 100;

    const loader = new THREE.STLLoader();

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
    animate();

    document.getElementById("stlFile").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;
      nomeArquivo = file.name;
      const reader = new FileReader();
      reader.onload = function (event) {
        const geometry = loader.parse(event.target.result);
        geometry.computeBoundingBox();
        geometry.computeVertexNormals();
        geometry.center();

        let volume = 0;
        const position = geometry.attributes.position;
        const vector = new THREE.Vector3();
        for (let i = 0; i < position.count; i += 3) {
          const p1 = new THREE.Vector3().fromBufferAttribute(position, i);
          const p2 = new THREE.Vector3().fromBufferAttribute(position, i + 1);
          const p3 = new THREE.Vector3().fromBufferAttribute(position, i + 2);
          volume += signedVolumeOfTriangle(p1, p2, p3);
        }
        volume = Math.abs(volume) / 1000; // Convertendo mm³ para cm³
        const preco = volume * 0.10;
        volumeGlobal = volume;
        precoGlobal = preco;

        document.getElementById("volumeDisplay").innerText = `Volume: ${volume.toFixed(2)} cm³`;
        document.getElementById("priceDisplay").innerText = `Preço: R$ ${preco.toFixed(2)}`;

        const material = new THREE.MeshNormalMaterial();
        const mesh = new THREE.Mesh(geometry, material);
        scene.clear();
        scene.add(mesh);
        scene.add(light);
      };
      reader.readAsArrayBuffer(file);
    });

    function signedVolumeOfTriangle(p1, p2, p3) {
      return p1.dot(p2.cross(p3)) / 6.0;
    }

    document.getElementById("enviarPedido").addEventListener("click", () => {
      const nome = document.getElementById("nome").value;
      const email = document.getElementById("email").value;
      const endereco = document.getElementById("endereco").value;

      if (!volumeGlobal || !precoGlobal) {
        alert("Por favor, envie um arquivo STL válido antes de enviar o pedido.");
        return;
      }

      emailjs.send("service_utkxrne", "template_959sfoi", {
        nome,
        email,
        endereco,
        arquivo: nomeArquivo,
        volume: volumeGlobal.toFixed(2),
        preco: precoGlobal.toFixed(2)
      }).then(() => {
        alert("Pedido enviado com sucesso! Gere o Pix abaixo.");
        gerarPix(precoGlobal.toFixed(2));
      }, (err) => {
        console.error(err);
        alert("Erro ao enviar pedido.");
      });
    });

    function gerarPix(valor) {
      const payload = `00020126360014BR.GOV.BCB.PIX01112899920051252040014Francisco Marques Rodrigues Bragança5204000053039865405${valor}5802BR5919Francisco Marques Rodrigues Bragança6009Jerônimo62100506Loja 3D6304`;
      QRCode.toCanvas(document.createElement("canvas"), payload, (err, canvasQR) => {
        if (err) return console.error(err);
        const container = document.getElementById("qrcode");
        container.innerHTML = "<h3>QR Code para pagamento via Pix:</h3>";
        container.appendChild(canvasQR);
      });
    }
  </script>
</body>
</html>
